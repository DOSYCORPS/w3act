@(form: Form[Instance], user: User, qaIssues: List[QaIssue], qaIssueCategories: Array[uk.bl.Const.QAIssueCategory])

@script = {
	<script>
		// This is the code that switches to the other page.
		// We do this via JavaScript, and not a normal hyperlink,
		// because that way we can communicate the current nav pill status as part of the link URL.
		function switchPage() {
			var activeTab = $('#myNavbar li.active'); // Here we grab the li that's currently marked as 'active'
			var href = activeTab.find('a').attr('href'); // here we grab the href of the link inside the active tab
			
			// And finally we just attach the href to view.html and forward the browser. 
			// An example URL would be: 'view.html#npld-scope'
			window.location.href="@routes.InstanceController.view(form.get.id)" + href;
		}
  
	
		(function() {
			var idle_timeout,
			SCOPE_URI = '/api/scope',
			MIN_TEXT_LENGTH = 4, // minimum length annotation must have before being allowed to the doScope server
			TRIGGER_CHARS = ". ,", // characters that force an doScope lookup
			IDLE_THRESHOLD = 500; // doScope is also done after IDLE_THRESHOLD milliseconds of key idleness
			
			// Does the Scope lookup
			var doScope = function(text) {
				$.getJSON(SCOPE_URI + text, function(data) {
					//alert("Is in scope: " + data);
					var lab = document.getElementById('isInScope'); 
					if (data) {
						lab.innerHTML = "is in scope";
						lab.style = "color: green";
					} else {
						lab.innerHTML = "is not in scope";
						lab.style = "color: red";
					}
				});
			};
		})();
		
	    $(document).ready(function() {
	          
	        // Restarts the keyboard-idleness timeout
			var restartIdleTimeout = function(text) {
	        	if (idle_timeout)
	            	window.clearTimeout(idle_timeout);
	            
	            idle_timeout = window.setTimeout(function() { doScope(text); }, IDLE_THRESHOLD);
			};		
	          
			$("#field_url").keyup(function() {
				var text = $('input[name=field_url]').val();
					
				if (text.length > MIN_TEXT_LENGTH) {
			        restartIdleTimeout(text);
			
			    	if (TRIGGER_CHARS.indexOf(text[text.length - 1]) > -1)
			        	doScope(text);
			    }
			});
		
			// This happens right after the document is loaded.
			// Our nav pills won't do anything by themselves, so we need to make sure we
			// check if the current URL has a #-component and if so, we activate the
			// appropriate pill.
			var hash = window.location.hash;
			if (hash.indexOf('#') == 0) {
				// We have a hash - let's see if it matches with nav pill href
				var el = $('#myNavbar a[href=' + hash + ']');
			
				// We have an <a> with this ID, and it has a parent node that's an <li>
				if (el && el.parent() && el.parent().prop('tagName') == 'LI') {
				    // So we activate this nav pill
				    $(el).tab('show');
				    window.scrollTo(0, 0);
				}
			}
      
			// This is completely optional!! But it keeps the hash in our current URL bar
			// in sync with the tab we have selected, so the pages stay nice and bookmarkable
			$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
				window.location.hash = ($(e.target).attr('href'));
				window.scrollTo(0, 0);
			})
		});		
	</script>
}

@main("", user, script) {
    
   	<div class="page-header">
	    <h1><a href="@routes.InstanceController.index()">Targets > Instances > </a>Instance @form.get.title</h1>
	</div>  
	<ul class="nav nav-tabs">
	   @if(form.get != null) {
	   <li><a onclick="switchPage(); return false;" href="@routes.InstanceController.view(form.get.id)">View</a></li>
	   }
	   @if((user.hasRole("sys_admin") || user.hasRole("archivist") || user.hasRole("expert_user"))) {
	   <li class="active"><a href="#">Edit</a></li> 
	   }
	</ul>

	<div class="tab-content padding-20">
           
		<ul class="nav nav-pills" id="myNavbar">
		    <li class="active"><a href="#qa" data-toggle="tab">QA</a></li>
	        <li><a href="#overview" data-toggle="tab">Overview</a></li>
	        <li><a href="#metadata" data-toggle="tab">Metadata</a></li>
	        <li><a href="#crawlpermission" data-toggle="tab">NPLD scope 
			@if(form.get.target.isInScopeAll()) {
				<font color="green">(+)</font>
			} else {
				<font color="red">(-)</font>
			}		        
			</a></li>
		    <li><a href="#crawlpolicy" data-toggle="tab">Crawl policy and Schedule</a></li>
		    <li><a href="#licensing" data-toggle="tab">UKWA Licensing</a></li>
	  	</ul>
	</div>
	
    @warningmessage(flash)
	@helper.form(action=routes.InstanceController.save) {
	
		<input type="hidden" name="id" value="@form.get.id">
		<input type="hidden" name="url" value="@form.get.url">
        <input type="hidden" name="user" value="@user.url">
	
		<div id="myTabContent" class="tab-content">
		
			<div class="tab-pane padding-20 fade active in" id="qa">    
	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
			            	<label for="qa_status" class="col-sm-6 control-label">QA Status</label>
						    <div class="col-sm-6">
								<select name="field_qa_status" id="field_qa_status" class="form-control">
									<option value="-1">None</option>
									@for(qaIssue <- qaIssues) {
						                @if(form.get.qaIssue != null && form.get.qaIssue.id == qaIssue.id) {             
									 		<option value="@qaIssue.id" selected>@qaIssue.name</option>
									 	} else {
										 	<option value="@qaIssue.id">@qaIssue.name</option>
									 	}									 	
								    }
								</select>						    
							</div>
			         	</div>
					</div>
				</div>
	
	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
			            	<label for="qa_issue_category" class="col-sm-6 control-label">QA Issue Category</label>
			            	<div class="col-sm-6">
								<select multiple name="qa_issue_category" class="form-control target-form-control" id="qa_issue_category">
						        	<option>None</option>
									@for(qaIssueCategory <- qaIssueCategories) {
						                @if(form.get.qaIssueCategory != null && form.get.qaIssueCategory.equals(qaIssueCategory.name)) {             
									 		<option value="@qaIssueCategory.name" selected>@qaIssueCategory.getValue</option>
									 	} else {
										 	<option value="@qaIssueCategory.name">@qaIssueCategory.getValue</option>
									 	}									 	
									}
								</select>
							</div>
			         	</div>
					</div>
				</div>
	
	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
			            	<label for="qa_notes" class="col-sm-6 control-label">QA Notes</label>
			            	<div class="col-sm-6">
				            	<textarea class="form-control" name="qa_notes" id="qa_notes" cols="100" rows="1" value="@form.get.qaNotes">@form.get.qaNotes</textarea>
							</div>
			         	</div>
					</div>
				</div>
	
	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
			            	<label for="quality_notes" class="col-sm-6 control-label">Technical Notes</label>
			            	<div class="col-sm-6">
				            	<textarea class="form-control" name="quality_notes" id="quality_notes" cols="100" rows="1" value="@form.get.notes">@form.get.notes</textarea>
							</div>
			         	</div>
					</div>
				</div>	
			</div>
		
			<div class="tab-pane padding-20" id="overview">
				<input type="hidden" name="user" value="@user.url">
	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
							<label for="inputTitle" class="col-sm-6 control-label">Title <font color="red">*</font></label>
						    <div class="col-sm-6">
				              <input class="form-control" name="title" id="inputTitle" size="60" placeholder="My title" type="text" value="@form.get.title">
							</div>
						</div>
					</div>
		     	</div>

	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
							<label class="col-sm-6 control-label">ID <font color="red">*</font></label>
						    <div class="col-sm-6">
								<input class="form-control" name="id" value="@form.get.id" size="30" readonly>
							</div>
						</div>
					</div>
		     	</div>

	    		<div class="row padding-10">
		     		<div class="col-md-12 col-xs-12 col-sm-12">
						<div class="form-group">
							<label for="inputUrls" class="col-sm-6 control-label">
								Seed URL(s) <font color="red">*</font> 
								<small class="text-center">(One or more URLs, separated by comma)</small>
							</label>
						    <div class="col-sm-6">
								<input class="form-control" name="fieldUrls" id="fieldUrls" placeholder="url1, url2" type="text" value="@form.get.target.fieldUrl()" readonly>
							</div>
						</div>
					</div>
		     	</div>	 
			</div>
		</div>
                        
        <div id="revisionArea" class="revision">
    		<div class="row padding-10">
	     		<div class="col-md-12 col-xs-12 col-sm-12">
					<div class="form-group">
		              	<label for="inputBody" class="col-sm-6 control-label">Revision log message</label>
					    <div class="col-sm-6">
               				<textarea class="form-control" name="revision" id="inputRevision">@form.get.revision</textarea>
						</div>
					</div>
				</div>
	     	</div>
		</div>

		<div class="padding-20">
			<div class="panel-group" id="accordion">
				<div class="panel panel-primary" id="panels">
					<div class="panel-heading">
				    	<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseInstances" style="color:#fff;">
				        	Instances
						</a>
					</div>
					<div id="collapseInstances" class="panel-collapse collapse">
						@for(fieldUrl <- form.get.target.fieldUrls) {
							<div class="panel-footer">
								<a class="brand" target="_blank" href="http://opera.bl.uk:8080/wayback/*/@fieldUrl.url">In QA Wayback</a>
							</div>
						    <div class="panel-footer">
					        	<a class="brand" target="_blank" href="http://www.webarchive.org.uk/wayback/archive/*/@fieldUrl.url">In Open UK Web Archive</a>
							</div>
							<div class="panel-footer">
								<a class="brand" target="_blank" href="http://www.webarchive.org.uk/mementos/search/@fieldUrl.url">In other web archives</a>
							</div>
						    <div class="panel-footer">
					        	<a class="brand" target="_blank" href="@fieldUrl.url">Live site</a>
							</div>
						}
					</div>
				</div>
			</div>
		</div>
	
		<div class="padding-20">
			<div class="alert alert-info">
				Provide an explanation of the changes you are making. This will help other authors understand your motivations.
			</div>
		</div>

		<div class="row padding-10 pull-right">
     		<div class="col-md-12 col-xs-12 col-sm-12">
				<div class="btn-group">
					<button type="submit" class="btn btn-primary" name="save" id="edit-save">Save</button>
					<button type="submit" class="btn btn-primary" name="delete" onclick="return confirm('Are you sure?');" id="delete">Delete</button>
		       </div>
			</div>
		</div>
	}
}


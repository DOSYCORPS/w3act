@(title: String, form: Form[JournalTitle], user: User, toDocument: Boolean)

@import helper.input
@import helper.inputText
@import helper.options
@import helper.select
@implicitField = @{ helper.FieldConstructor(templates.standardFieldConstructor.f) }

@scripts = {
	<script type="text/javascript">
		$(function() {
			$("#collectionTree").dynatree({
				checkbox: true,
				classNames: {checkbox: "dynatree-radio"},
				selectMode: 1,
				children: @Html(TargetController.getCollectionsJsonData("none")),
				onSelect: function(select, node) {
					// Get a list of all selected nodes, and convert to a key array:
					var selKeys = $.map(node.tree.getSelectedNodes(), function(node){
						return node.data.key;
					});
					$("#blCollectionSubset")[0].value = selKeys.join(", ");
					// Get a list of all selected TOP nodes
					var selRootNodes = node.tree.getSelectedNodes(true);
					// ... and convert to a key array:
					var selRootKeys = $.map(selRootNodes, function(node){
						return node.data.key;
					});
				}
			});
			$("#subjectTree").dynatree({
				checkbox: true,
				selectMode: 2,
				children: @Html(TargetController.getSubjectsJsonData("empty")),
				onSelect: function(select, node) {
					// Get a list of all selected nodes, and convert to a key array:
					var selKeys = $.map(node.tree.getSelectedNodes(), function(node){
						return node.data.key;
					});
					$("#subject")[0].value = selKeys.join(", ");
					// Get a list of all selected TOP nodes
					var selRootNodes = node.tree.getSelectedNodes(true);
					// ... and convert to a key array:
					var selRootKeys = $.map(selRootNodes, function(node){
						return node.data.key;
					});
				}
			});
			$("#collectionTree").dynatree("getTree").selectKey($("#blCollectionSubset")[0].value);
			var subjects = $("#subject")[0].value.split(", ");
			for (subject of subjects) {
				$("#subjectTree").dynatree("getTree").selectKey(subject);
			}
		});
	</script>
}

@main(title, user, scripts) {
	<div class="page-header">
    	<h1>
    		@if(toDocument) {
    			<a href="@routes.Documents.list("",form("watchedTarget.id").value)">Documents</a> >
				<a href="@routes.Documents.continueEdit()">@play.mvc.Controller.session("filename")</a> >
			} else {
				<a href="@routes.Targets.index()">Targets</a> >
				<a href="@routes.Targets.view(form("watchedTarget.target.url").value)#watchedTarget">@form("watchedTarget.target.title").value</a> >
			}
			@if(form("id").value != null) {
				@form("title").value
			} else {
				New Journal Title
			}
		</h1>
	</div>
	
	@warningmessage(flash)
	@helper.form(action = routes.JournalTitles.save(toDocument)) {
		<div>
			<input type="hidden" name="id" value="@form("id").value">
			<input type="hidden" name="watchedTarget.id" value="@form("watchedTarget.id").value">
			<input type="hidden" name="watchedTarget.target.nid" value="@form("watchedTarget.target.nid").value">
			<input type="hidden" name="watchedTarget.target.url" value="@form("watchedTarget.target.url").value">
			
			@defining('class -> "form-control") { textualElement =>
				@inputText(form("title"), '_label -> "Journal Title", textualElement)
				@input(form("watchedTarget.target.title"), '_label -> "Target") { (id, name, value, args) =>
					@value
					<input type="hidden" name="@name" id="@id" value="@value">
				}
				@inputText(form("issn"), '_label -> "ISSN", textualElement)
				@select(form("frequency"), options(JournalTitle.frequencies), '_label -> "Frequency", textualElement)
				@inputText(form("publisherName"), '_label -> "Publisher Name", textualElement)
				@input(form("language"), '_label -> "Language") { (id, name, value, args) =>
					@value
					<input type="hidden" name="@name" id="@id" value="@value">
				}
				@input(form("blCollectionSubset"), '_label -> "BL Collection Subset") { (id, name, value, args) =>
					<span id="collectionTree"></span>
					<input type="hidden" name="@name" id="@id" value="@value">
				}
				@input(form("subject"), '_label -> "Subject(s)") { (id, name, value, args) =>
					<span id="subjectTree"></span>
					<input type="hidden" name="@name" id="@id" value="@value">
				}
			}
			
			<input type="submit" class="btn primary" value="Save">
			@if(form("id").value != null && form("id").value != "") {
				<input type="submit" name="delete" class="btn primary" value="Delete">
			}
		</div>
	}
}

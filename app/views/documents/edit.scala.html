@(title: String, form: Form[Document], user: User, editable: Boolean)

@import helper.options
@import scala.List
@import templates.checkbox
@import templates.checkbox2
@import templates.inputText
@import templates.select
@import templates.splitInputText

@implicitField = @{ helper.FieldConstructor(templates.ratio5to7FieldConstructor.f) }

@scripts = {
	<script src="@routes.Assets.at("javascripts/parse-date.js")" type="text/javascript"></script>
	<script type="text/javascript">
		function getSelectionText() {
			var text = "";
			var win=document.getElementById("document_view").contentWindow;
			//var win=window;
			if (win.getSelection) {
				var node = win.getSelection().anchorNode;
				var cssSelector = "";
				var idFound = false;
				while (node.parentNode && !idFound) {
					var node = node.parentNode;
					var localCssSelector = node.localName;
					if (node.id) {
						localCssSelector += "#" + node.id;
						idFound = true;
					}
					else if (node.className) {
						localCssSelector += "." + node.className.replace(/[ ]/g, '.');
					}
					if (cssSelector) {
						cssSelector = localCssSelector + " " + cssSelector;
					}
					else {
						cssSelector = localCssSelector;
					}
				}
				//console.log("cssSelector: " + cssSelector);
				text = win.getSelection().toString();
				//console.log("text: " + text);
			} else if (win.document.selection && win.document.selection.type != "Control") {
				text = win.document.selection.createRange().text;
				alert("case2: " + text);
			}
			return text;
		}

		function fillInput(id) {
			document.getElementById(id).value = getSelectionText().trim();
			$("#selection_menu").css({display: "none"});
		}

		function fillDate(id) {
			var rawDate = getSelectionText().trim();
			var formattedDate = parseDate(rawDate);
			if (formattedDate)
				document.getElementById(id).value = parseDate(rawDate);
			$("#selection_menu").css({display: "none"});
			fillYear();
		}

		function fillAuthor() {
			var author = getSelectionText().trim();
			var authorNumber = 1;
			while (authorNumber < 3 && document.getElementById("author" + authorNumber + "Fn").value)
				authorNumber++;
			var firstName;
			var lastName;
			var commaPosition = author.indexOf(",");
			if(commaPosition > 0) {
				lastName = author.substring(0, commaPosition).trim();
				firstName = author.substring(commaPosition + 1).trim();
			} else {
				var spacePosition = author.indexOf(" ");
				firstName = author.substring(0, spacePosition).trim();
				lastName = author.substring(spacePosition + 1).trim();
			}
			document.getElementById("author" + authorNumber + "Fn").value = firstName;
			document.getElementById("author" + authorNumber + "Ln").value = lastName;
			$("#selection_menu").css({display: "none"});
		}

		function fillYear() {
			var date = document.getElementById("publicationDate").value;
			var publicationYear = document.getElementById("publicationYear");
			if (date.indexOf("-") >= 0) {
				var dateParts = date.split("-");
				publicationYear.value = dateParts[dateParts.length-1];
				publicationYear.readOnly = true;
			} else {
				publicationYear.readOnly = false;
			}
		}
		
		function openPopup(url) {
			var breite = screen.width;
			var hoehe = screen.height; 
			var xps = ((breite/2)-379);
			var yps = breite/2;
			window.open(url, "name",
					"width=" + yps + "," +
					"height=" + hoehe + "," +
					"left=" + yps + "," +
					"scrollbars=yes"
			);
		}
		
		function show(element) {
			element.css({display: "block"});
		}

		function hide(element) {
			element.css({display: "none"});
		}
	
		function toggleVisibility() {
			var select = document.getElementById("type");
			var type = select.selectedIndex;
			var book_general = $("#book_general, #book_general_buttons");
			var book = $("#book, #book_buttons");
			var journal_general = $("#journal_general, #journal_general_buttons");
			var author = $("#author, #author_buttons");
			hide(book_general);
			hide(book);
			hide(journal_general);
			hide(author);
			switch(type) {
				case 1:
					show(book_general);
					show(book);
					show(author);
					break;
				@*case BOOK_CHAPTER:
					show(book_general);
					show(author);
					break;*@
				case 2:
					show(journal_general);
					show(author);
					break;
				case 3:
					show(journal_general);
					break;
			}
		}
		
		function defineDefaultButton() {
			$("form input").keypress(function (e) {
				if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
					$('input[type=submit].btn-primary').click();
					return false;
				} else {
					return true;
				}
			});
		}
		
		var previousSelection="";
		
		$(function() {
			toggleVisibility();
			defineDefaultButton();
			@if(editable) {
				document.getElementById("document_view").contentWindow.onmouseup =
					function showOptions(event) {
						//console.log(event);
						var selectionText = getSelectionText();
						if (selectionText && previousSelection != selectionText) {
							$("#selection_menu").css({display: "block", left: event.pageX - 50});
							if (event.pageY < 300)
								$("#selection_menu").css({top: event.pageY + 15, bottom: "auto"});
							else
								$("#selection_menu").css({bottom: 600 - event.pageY, top: "auto"});
						} else {
							$("#selection_menu").css({display: "none"});
						}
						previousSelection = selectionText;
					};
			}
		});
	</script>
}
@styles = {
	<style type="text/css">
		.container {
			width: 98%;
		}
	</style>
}

@main(title, user, scripts, styles) {
	
	<div class="page-header">
    	<h1>
    		<a href="@routes.Documents.list(new DocumentFilter().withWatchedTarget(new Long(form("watchedTarget.id").value)))">Documents</a> >
    		@form("title").value
    	</h1>
	</div>
	
	<ul class="nav nav-tabs">
		@if(editable) {
			<li><a href="@routes.Documents.view(new Long(form("id").value))">View</a></li>
			<li class="active"><a href="#">Edit</a></li>
		} else {
			<li class="active"><a href="#">View</a></li>
			@if(form("status").value != Document.Status.SUBMITTED.toString) {
				<li><a href="@routes.Documents.edit(new Long(form("id").value))">Edit</a></li>
			}
		}
	</ul>
	
	@warningmessage(flash)
	@helper.form(if (editable) routes.Documents.save(new Long(form("id").value)) else routes.Documents.submit(new Long(form("id").value))) {
		<div class="col-md-6">
			<input type="hidden" name="id" value="@form("id").value">
			<input type="hidden" name="landingPageUrl" value="@form("landingPageUrl").value">
			<input type="hidden" name="documentUrl" value="@form("documentUrl").value">
			<input type="hidden" name="htmlFilename" value="@form("htmlFilename").value">
			<input type="hidden" name="status" value="@form("status").value">
			<input type="hidden" name="book.id" value="@form("book.id").value">
			<input type="hidden" name="book.id_document" value="@form("id").value">
			<input type="hidden" name="journal.id" value="@form("journal.id").value">
			<input type="hidden" name="journal.id_document" value="@form("id").value">
			<input type="hidden" name="watchedTarget.id" value="@form("watchedTarget.id").value">
			<input type="hidden" name="watchedTarget.target.nid" value="@form("watchedTarget.target.nid").value">
			<input type="hidden" name="watchedTarget.target.title" value="@form("watchedTarget.target.title").value">

			@inputText(form("title"), editable, '_label -> "Title")
			@inputText(form("doi"), editable, '_label -> "DOI (Digital Object Identifier)")
			@inputText(form("publicationDate"), editable, '_label -> "Publication Date", 'onchange -> "fillYear()")
			@inputText(form("publicationYear"), editable, '_label -> "Year of Publication")
			@inputText(form("filename"), editable, '_label -> "Filename")
			@checkbox(form("priorityCataloguing"),
				editable,
				'_label -> "Priority Cataloguing")
			@helper.input(form("services"), '_label -> "Services") { (id, name, value, args) =>
				@for(portal <- Documents.portalList.getList()) {
					@*if(Target.find.byId(new Long(form("watchedTarget.target.nid").value)).indicateUkwaLicenceStatus) {*@
						@checkbox2(form("portal_" + portal.id), editable, '_label -> portal.title)(
							helper.FieldConstructor(templates.checkboxFieldConstructor.f)
						)
					@*} else {
						@checkbox2(form("portal_" + portal.id), editable,'_label -> portal.title, 'disabled -> "disabled")(
							helper.FieldConstructor(templates.checkboxFieldConstructor.f)
						)
					}*@
				}
			}
			@helper.input(form("subjects"), '_label -> "Subjects") { (id, name, value, args) =>
				<div @if(editable) {class="scroll-box"}>
					@for(fastSubject <- FastSubject.find.orderBy("name").findList()) {
						@checkbox2(form(fastSubject.fastId), editable, '_label -> fastSubject.name)(
							helper.FieldConstructor(templates.checkboxFieldConstructor.f)
						)
					}
				</div>
			}
			@select(form("type"),
				options(List("", Document.Type.BOOK.toString,
					Document.Type.JOURNAL_ARTICLE.toString,
					Document.Type.JOURNAL_ISSUE.toString)),
				editable,
				'_label -> "Submission Type", 'onchange -> "toggleVisibility()")
			<div id="book_general">
				@helper.input(form("blCollectionSubset"), '_label -> "BL Collection Subset") { (id, name, value, args) =>
					@for(blCollectionSubset <- Documents.blCollectionSubsetList.getList()) {
						@checkbox2(form("blCollectionSubset_" + blCollectionSubset.id), editable,'_label -> blCollectionSubset.title)(
							helper.FieldConstructor(templates.checkboxFieldConstructor.f)
						)
					}
				}
				@inputText(form("book.isbn"), editable, '_label -> "ISBN")
				@inputText(form("book.corporateAuthor"), editable, '_label -> "Corporate Author")
			</div>
			<div id="book">
				@inputText(form("book.series"), editable, '_label -> "Series")
				@inputText(form("book.seriesNumber"), editable, '_label -> "Series Number")
				@inputText(form("book.publisher"), editable, '_label -> "Publisher")
				@inputText(form("book.edition"), editable, '_label -> "Edition")
			</div>
			<div id="journal_general">
				@select(form("journal.journalTitleId"), options(Documents.getJournalTitles(form)), editable, '_label -> "Journal Title")
				@if(editable) {
					<input type="submit" name="journalTitle" class="btn btn-success" value="New Journal Title">
				}
				@inputText(form("journal.volume"), editable, '_label -> "Volume")
				@inputText(form("journal.issue"), editable, '_label -> "Issue/Part")
			</div>
			<div id="author">
				@splitInputText(form("author1Fn"), form("author1Ln"), editable, '_label -> "Author(s)")
				@splitInputText(form("author2Fn"), form("author2Ln"), editable, '_label -> "")
				@splitInputText(form("author3Fn"), form("author3Ln"), editable, '_label -> "")
			</div>
			
			<a target="landingPage" onclick="openPopup('@form("landingPageUrl").value')">Open Landing Page</a><br>
			<a target="document" onclick="openPopup('@form("documentUrl").value')">Open Document</a><br>
			@if(editable) {
				<input type="submit" class="btn btn-primary" value="Save">
			} else {
				@if(form("status").value != Document.Status.SUBMITTED.toString && !form("type").value.isEmpty) {
					<input type="submit" name="submit" class="btn btn-primary" value="Submit" onclick="return confirm('Are you sure?');">
				}
			}
		</div>
		
		<div class="col-md-6">
			<div id="selection_menu" class="navbar navbar-default" style="display: none; position: absolute;
				margin-left: 15px; padding: 8px">
				<div>
					<input type="button" class="btn btn-success" value="Title" onclick="fillInput('title')" style="width: 100%">
				</div>
				<div style="padding-top: 5px">
					<input type="button" class="btn btn-success" value="DOI" onclick="fillInput('doi')" style="width: 100%">
				</div>
				<div style="padding-top: 5px">
					<input type="button" class="btn btn-success" value="Publication Date" onclick="fillDate('publicationDate')" style="width: 100%">
				</div>
				<div style="padding-top: 5px">
					<input type="button" class="btn btn-success" value="Year of Publication" onclick="fillInput('publicationYear')" style="width: 100%">
				</div>
				<div id="book_general_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="ISBN" onclick="fillInput('book_isbn')" style="width: 100%">
					</div>
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Corporate Author" onclick="fillInput('book_corporateAuthor')" style="width: 100%">
					</div>
				</div>
				<div id="book_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Series" onclick="fillInput('book_series')" style="width: 100%">
					</div>
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Series Number" onclick="fillInput('book_seriesNumber')" style="width: 100%">
					</div>
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Publisher" onclick="fillInput('book_publisher')" style="width: 100%">
					</div>
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Edition" onclick="fillInput('book_edition')" style="width: 100%">
					</div>
				</div>
				<div id="journal_general_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Volume" onclick="fillInput('journal_volume')" style="width: 100%">
					</div>
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Issue/Part" onclick="fillInput('journal_issue')" style="width: 100%">
					</div>
				</div>
				<div id="author_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Author" onclick="fillAuthor()" style="width: 100%">
					</div>
				</div>
			</div>
			<iframe id="document_view" src="@{
					if(form("status").value == Document.Status.SUBMITTED.toString) routes.Helper.passthrough(form("documentUrl").value,"")
					else routes.Documents.html(form("htmlFilename").value)
				}"
				width="100%" height="768"></iframe>
		</div>
	}
}

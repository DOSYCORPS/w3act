@(title: String, form: Form[Document], user: User, journalTitles: java.util.Map[String, String])

@import helper.checkbox
@import helper.inputDate
@import helper.inputText
@import helper.options
@import helper.select
@import scala.List
@implicitField = @{ helper.FieldConstructor(fieldConstructorTemplate.f) }

@scripts = {
	<script type="text/javascript">
		function getSelectionText() {
			var text = "";
			var win=document.getElementById("document_view").contentWindow;
			//var win=window;
			if (win.getSelection) {
				var node = win.getSelection().anchorNode;
				var cssSelector = "";
				var idFound = false;
				while (node.parentNode && !idFound) {
					var node = node.parentNode;
					var localCssSelector = node.localName;
					if (node.id) {
						localCssSelector += "#" + node.id;
						idFound = true;
					}
					else if (node.className) {
						localCssSelector += "." + node.className.replace(/[ ]/g, '.');
					}
					if (cssSelector) {
						cssSelector = localCssSelector + " " + cssSelector;
					}
					else {
						cssSelector = localCssSelector;
					}
				}
				console.log("cssSelector: " + cssSelector);
				text = win.getSelection().toString();
				console.log("text: " + text);
			} else if (win.document.selection && win.document.selection.type != "Control") {
				text = win.document.selection.createRange().text;
				alert("case2: " + text);
			}
			return text;
		}

		function fillInput(id) {
			//var date = new Date(getSelectionText().trim());
			//console.log(date);
			document.getElementById(id).value = getSelectionText().trim();
			$("#selection_menu").css({display: "none"});
		}
		
		function openPopup(url) {
			var breite = screen.width;
			var hoehe = screen.height; 
			var xps = ((breite/2)-379);
			var yps = breite/2;
			window.open(url, "name",
					"width=" + yps + "," +
					"height=" + hoehe + "," +
					"left=" + yps + "," +
					"scrollbars=yes"
			);
		}
		
		function show(element) {
			element.css({display: "block"});
		}

		function hide(element) {
			element.css({display: "none"});
		}
		
		function toggleVisibility() {
			var select = document.getElementById("type");
			var type = select.selectedIndex;
			var book_general = $("#book_general, #book_general_buttons");
			var book = $("#book");
			var journal_general = $("#journal_general");
			var journal_article = $("#journal_article, #journal_article_buttons");
			hide(book_general);
			hide(book);
			hide(journal_general);
			hide(journal_article);
			switch(type) {
				case 1:
					show(book_general);
					show(book);
					break;
				case 2:
					show(book_general);
					break;
				case 3:
					show(journal_general);
					show(journal_article);
					break;
				case 4:
					show(journal_general);
					break;
			}
		}
		
		var previousSelection="";
		
		$(function() {
			toggleVisibility();
			document.getElementById("document_view").contentWindow.onmouseup =
				function showOptions(event) {
					console.log(event);
					var selectionText = getSelectionText();
					if (selectionText && previousSelection != selectionText) {
						$("#selection_menu").css({display: "block"});
						$("#selection_menu").css({left: event.pageX, top: event.pageY+10});
					} else {
						$("#selection_menu").css({display: "none"});
					}
					previousSelection = selectionText;
				};
		});
	</script>
}

@main(title, user, scripts) {
	
	<div class="page-header">
    	<h1><a href="@routes.Documents.list()">Documents</a> > @form("filename").value</h1>
	</div>
	
	@helper.form(action = routes.Documents.save()) {
		<div class="col-md-5">
			<input type="hidden" name="id" value="@form("id").value">
			<input type="hidden" name="landingPageUrl" value="@form("landingPageUrl").value">
			<input type="hidden" name="documentUrl" value="@form("documentUrl").value">
			<input type="hidden" name="filename" value="@form("filename").value">
			<input type="hidden" name="book.id" value="@form("book.id").value">
			<input type="hidden" name="book.id_document" value="@form("id").value">
			<input type="hidden" name="journal.id" value="@form("journal.id").value">
			<input type="hidden" name="journal.id_document" value="@form("id").value">

			@defining('class -> "form-control") { textualElement =>
				@inputText(form("title"), '_label -> "Title", textualElement)
				@inputText(form("doi"), '_label -> "DOI (Digital Object Identifier)", textualElement)
				@inputText(form("publicationDate"), '_label -> "Publication Date", textualElement)
				@inputText(form("filename"), '_label -> "Filename", textualElement)
				@select(form("type"),
					options(List("","Book", "Book Chapter", "Journal Article", "Journal Issue")),
					'_label -> "Submission Type", 'onchange -> "toggleVisibility()", textualElement)
				<div id="book_general">
					@inputText(form("book.isbn"), '_label -> "ISBN", textualElement)
					@inputText(form("book.author"), '_label -> "Author(s)", textualElement)
					@inputText(form("book.corporate_author"), '_label -> "Corporate Author", textualElement)
					@checkbox(form("book.priorityCataloguing"), '_label -> "Priority Cataloguing", 'class -> "checkbox")
				</div>
				<div id="book">
					@inputText(form("book.series"), '_label -> "Series", textualElement)
					@inputText(form("book.publisher"), '_label -> "Publisher", textualElement)
					@inputText(form("book.edition"), '_label -> "Edition", textualElement)
					@inputText(form("book.publicationYear"), '_label -> "Year of Publication", textualElement)
				</div>
				<div id="journal_general">
					@select(form("journal.journalTitleId"),
						options(journalTitles),
						'_label -> "Journal Title", textualElement)
					<input type="submit" name="journalTitle" class="btn btn-success" value="New Journal Title">
					@inputText(form("journal.publicationYear"), '_label -> "Year of Publication", textualElement)
					@inputText(form("journal.volume"), '_label -> "Volume", textualElement)
					@inputText(form("journal.issue"), '_label -> "Issue/Part", textualElement)
				</div>
				<div id="journal_article">
					@inputText(form("journal.author"), '_label -> "Author(s)", textualElement)
				</div>
			}
			
			<a target="landingPage" onclick="openPopup('@form("landingPageUrl").value')">Open Landing Page</a><br>
			<a target="document" onclick="openPopup('@form("documentUrl").value')">Open Document</a><br>
			<input type="submit" class="btn primary" value="Save">
		</div>
		
		<div class="col-md-7">
			<div id="selection_menu" class="navbar navbar-default" style="display: none; position: absolute;
				margin-left: 15px; padding: 8px">
				<div>
					<input type="button" class="btn btn-success" value="Title" onclick="fillInput('title')" style="width: 100%">
				</div>
				<div style="padding-top: 5px">
					<input type="button" class="btn btn-success" value="DOI" onclick="fillInput('doi')" style="width: 100%">
				</div>
				@*<div style="padding-top: 5px">
					<input type="button" class="btn btn-success" value="Publication Date" onclick="fillInput('publicationDate')" style="width: 100%">
				</div>*@
				<div id="book_general_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Author(s)" onclick="fillInput('book_author')" style="width: 100%">
					</div>
				</div>
				<div id="journal_article_buttons">
					<div style="padding-top: 5px">
						<input type="button" class="btn btn-success" value="Author(s)" onclick="fillInput('journal_author')" style="width: 100%">
					</div>
				</div>
			</div>
			<iframe id="document_view" src="@routes.Assets.at(form("htmlFilename").value)"
				width="100%" height="600"></iframe>
		</div>
	}
}
